name: Build and Release

# 触发条件：当 Release 发布时运行
on:
  release:
    types: [ published ]

# 权限配置：允许 Action 上传文件到 Release
permissions:
  contents: write

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ windows-latest, macos-latest, ubuntu-latest ]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20 # 建议使用 LTS 版本
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      # 1. 构建 Electron 主进程和预加载脚本
      # package.json 中的 build:electron 脚本
      - name: Build Electron Main & Preload
        run: npm run build:electron

      # 2. 构建 Vue 渲染进程
      # 使用 vite build 生成 dist 目录
      - name: Build Renderer (Vite)
        run: npx vite build

      # 3. 打包并发布 (Windows)
      # 仅在 windows-latest 运行
      # --win 对应 package.json 中的 win 配置 (nsis, portable)
      - name: Build & Publish (Windows)
        if: matrix.os == 'windows-latest'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --win --publish always

      # 3. 打包并发布 (macOS)
      # 仅在 macos-latest 运行
      # --mac 对应 package.json 中的 mac 配置 (dmg, zip)
      # 注意：为了避免 macOS 上的代码签名错误，如果没有配置证书，可能需要禁用签名或接受未签名构建
      - name: Build & Publish (macOS)
        if: matrix.os == 'macos-latest'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 如果您有苹果开发者证书，请在 GitHub Secrets 中配置以下变量
          # CSC_LINK: ${{ secrets.CSC_LINK }}
          # CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
        run: npx electron-builder --mac --publish always

      # 3. 打包并发布 (Linux)
      # 仅在 ubuntu-latest 运行
      # --linux 对应 package.json 中的 linux 配置 (AppImage, deb, rpm)
      - name: Build & Publish (Linux)
        if: matrix.os == 'ubuntu-latest'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx electron-builder --linux --publish always
